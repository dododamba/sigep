{% extends 'management.html.twig' %}

{% block title %}Dashboard Top Management - SIGEP Tchad{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard Armoirie CSS -->
    <link rel="stylesheet" href="{{ asset('css/dashboard-armoirie.css') }}">
{% endblock %}

{% block body %}
<!-- ============================================
     HEADER - Style Armoirie du Tchad
     ============================================ -->
<header class="header">
    <div class="header-content">
        <div class="header-brand">
            <div class="logo-container">
                <div class="logo-emblem">
                    <img src="{{ asset('logo.png') }}" alt="Armoirie du Tchad" onerror="this.style.display='none'">
                </div>
                <div class="brand-text">
                    <h1 class="brand-name">SIGEP</h1>
                    <span class="brand-subtitle">R√©publique du Tchad</span>
                </div>
            </div>
        </div>

      
        <div class="header-user">
            <div class="user-avatar">
                <i data-lucide="user"></i>
            </div>
            <div class="user-info">
                <span class="user-name">{{ app.user ? app.user.firstname ~ ' ' ~ app.user.lastname : 'Manager' }}</span>
                <span class="user-role">Top Management</span>
            </div>
        </div>
    </div>
</header>

<!-- MAIN CONTENT -->
<main class="main-content">
    <!-- Page Title -->
    <div class="page-title">
        <h1>Dashboard Top Management</h1>
        <p>Vue strat√©gique et indicateurs de performance</p>
        <div class="last-update">
            <i data-lucide="clock"></i>
            Derni√®re mise √† jour : {{ "now"|date("d/m/Y √† H:i") }}
        </div>
    </div>

    
   <div class="header-filters">
            <form method="get" action="{{ path('app_top_management_dashboard') }}" class="filter-form">
                <div class="filter-group">
                    <select name="year" id="filterYear" class="filter-select" onchange="this.form.submit()">
                        <option value="">Toutes les ann√©es</option>
                        {% for year in years %}
                            <option value="{{ year }}" {% if filters.year == year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <i data-lucide="calendar" class="filter-icon"></i>
                </div>

                <div class="filter-group">
                    <select name="institution" id="filterInstitution" class="filter-select" onchange="this.form.submit()">
                        <option value="">Toutes les institutions</option>
                        {% for institution in institutions %}
                            <option value="{{ institution.id }}" {% if filters.institution == institution.id %}selected{% endif %}>
                                {{ institution.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <i data-lucide="building" class="filter-icon"></i>
                </div>
            </form>
        </div>

    <!-- KPI CARDS -->
    <section class="kpi-section">
        <div class="kpi-grid">
            <!-- KPI 1: Total Projets -->
            <div class="kpi-card primary">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <i data-lucide="folder-kanban"></i>
                    </div>
                    <div class="kpi-trend up">
                        <i data-lucide="trending-up"></i>
                        <span>+12%</span>
                    </div>
                </div>
                <div class="kpi-body">
                    <h3 class="kpi-value" data-count="{{ kpis.totalProjects }}">0</h3>
                    <p class="kpi-label">Total Projets</p>
                    <p class="kpi-sublabel">
                        üü¢ {{ kpis.activeProjects }} en cours ‚Ä¢ ‚úÖ {{ kpis.completedProjects }} termin√©s
                    </p>
                </div>
            </div>

            <!-- KPI 2: Budget Total -->
            <div class="kpi-card gold">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <i data-lucide="banknote"></i>
                    </div>
                </div>
                <div class="kpi-body">
                    <h3 class="kpi-value">{{ (kpis.totalBudget / 1000000000)|number_format(1, '.', ' ') }}</h3>
                    <p class="kpi-label">Budget Total (Mds FCFA)</p>
                    <p class="kpi-sublabel">
                        üí∞ {{ (kpis.totalBudget)|number_format(0, ',', ' ') }} FCFA
                    </p>
                </div>
            </div>

            <!-- KPI 3: Taux de D√©caissement -->
            <div class="kpi-card success">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <i data-lucide="trending-up"></i>
                    </div>
                </div>
                <div class="kpi-body">
                    <h3 class="kpi-value" data-count="{{ kpis.disbursementRate }}">0</h3>
                    <p class="kpi-label">Taux de D√©caissement (%)</p>
                    <p class="kpi-sublabel">
                        {{ (kpis.totalDisbursed / 1000000000)|number_format(1, '.', ' ') }} Mds d√©caiss√©s
                    </p>
                </div>
            </div>

            <!-- KPI 4: R√©alisation Physique -->
            <div class="kpi-card warning">
                <div class="kpi-header">
                    <div class="kpi-icon">
                        <i data-lucide="activity"></i>
                    </div>
                </div>
                <div class="kpi-body">
                    <h3 class="kpi-value" data-count="{{ kpis.avgPhysicalProgress }}">0</h3>
                    <p class="kpi-label">R√©alisation Physique Moyenne (%)</p>
                    <p class="kpi-sublabel">
                        Progression globale des projets
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- M√âTRIQUES MANAGEMENT -->
    <section class="management-section">
        <div class="section-header">
            <h2 class="section-title">
                <i data-lucide="briefcase"></i>
                M√©triques Top Management
            </h2>
        </div>

        <div class="management-grid">
            <div class="metric-card metric-gold">
                <div class="metric-icon">
                    <i data-lucide="wallet"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-label">Valeur du Portefeuille</span>
                    <span class="metric-value">{{ (managementMetrics.portfolioValue / 1000000000)|number_format(1, '.', ' ') }} Mds</span>
                    <span class="metric-sublabel">FCFA</span>
                </div>
            </div>

            <div class="metric-card metric-success">
                <div class="metric-icon">
                    <i data-lucide="target"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-label">Efficacit√© du Financement</span>
                    <span class="metric-value">{{ managementMetrics.fundingEfficiency }}%</span>
                    <span class="metric-sublabel">Fonds activ√©s / Budget</span>
                </div>
            </div>

            <div class="metric-card metric-primary">
                <div class="metric-icon">
                    <i data-lucide="clock"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-label">Respect des D√©lais</span>
                    <span class="metric-value">{{ managementMetrics.onTimeRate }}%</span>
                    <span class="metric-sublabel">{{ managementMetrics.delayRate }}% en retard</span>
                </div>
            </div>

            <div class="metric-card metric-warning">
                <div class="metric-icon">
                    <i data-lucide="building-2"></i>
                </div>
                <div class="metric-content">
                    <span class="metric-label">Projets par Institution</span>
                    <span class="metric-value">{{ managementMetrics.projectsPerInstitution }}</span>
                    <span class="metric-sublabel">{{ managementMetrics.activeInstitutions }} institutions</span>
                </div>
            </div>
        </div>
    </section>

    <!-- ANALYSE DES RISQUES -->
    <section class="risk-section">
        <div class="section-header">
            <h2 class="section-title">
                <i data-lucide="alert-triangle"></i>
                Analyse des Risques Globaux
            </h2>
        </div>

        <div class="risk-grid">
            <div class="risk-card risk-low">
                <div class="risk-icon">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="risk-content">
                    <span class="risk-count">{{ globalRiskAnalysis.lowRisk }}</span>
                    <span class="risk-label">Risque Faible</span>
                    <span class="risk-percent">{{ globalRiskAnalysis.lowRiskPercent }}%</span>
                </div>
            </div>

            <div class="risk-card risk-medium">
                <div class="risk-icon">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="risk-content">
                    <span class="risk-count">{{ globalRiskAnalysis.mediumRisk }}</span>
                    <span class="risk-label">Risque Moyen</span>
                    <span class="risk-percent">{{ globalRiskAnalysis.mediumRiskPercent }}%</span>
                </div>
            </div>

            <div class="risk-card risk-high">
                <div class="risk-icon">
                    <i data-lucide="alert-triangle"></i>
                </div>
                <div class="risk-content">
                    <span class="risk-count">{{ globalRiskAnalysis.highRisk }}</span>
                    <span class="risk-label">Risque √âlev√©</span>
                    <span class="risk-percent">{{ globalRiskAnalysis.highRiskPercent }}%</span>
                </div>
            </div>
        </div>

        {% if globalRiskAnalysis.criticalProjectsCount > 0 %}
        <div class="risk-alert">
            <i data-lucide="alert-triangle"></i>
            <strong>Attention :</strong> {{ globalRiskAnalysis.criticalProjectsCount }} projet(s) critique(s) n√©cessitent une action imm√©diate
        </div>
        {% endif %}
    </section>

    <!-- TENDANCES -->
    <section class="trends-section">
        <div class="section-header">
            <h2 class="section-title">
                <i data-lucide="trending-up"></i>
                Tendances et Croissance
            </h2>
        </div>

        <div class="trends-grid">
            <div class="trend-card">
                <div class="trend-header">
                    <h4>Croissance des Projets</h4>
                    <span class="trend-badge {{ trends.projectGrowth >= 0 ? 'trend-positive' : 'trend-negative' }}">
                        {{ trends.projectGrowth >= 0 ? '+' : '' }}{{ trends.projectGrowth }}%
                    </span>
                </div>
                <div class="trend-body">
                    <div class="trend-comparison">
                        <div class="trend-item">
                            <span class="trend-year">{{ "now"|date("Y") }}</span>
                            <span class="trend-value">{{ trends.currentYearProjects }} projets</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-year">{{ ("now"|date("Y")) - 1 }}</span>
                            <span class="trend-value">{{ trends.lastYearProjects }} projets</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="trend-card">
                <div class="trend-header">
                    <h4>Croissance du Budget</h4>
                    <span class="trend-badge {{ trends.budgetGrowth >= 0 ? 'trend-positive' : 'trend-negative' }}">
                        {{ trends.budgetGrowth >= 0 ? '+' : '' }}{{ trends.budgetGrowth }}%
                    </span>
                </div>
                <div class="trend-body">
                    <div class="trend-comparison">
                        <div class="trend-item">
                            <span class="trend-year">{{ "now"|date("Y") }}</span>
                            <span class="trend-value">{{ (trends.currentYearBudget / 1000000000)|number_format(1, '.', ' ') }} Mds FCFA</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-year">{{ ("now"|date("Y")) - 1 }}</span>
                            <span class="trend-value">{{ (trends.lastYearBudget / 1000000000)|number_format(1, '.', ' ') }} Mds FCFA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- GRAPHIQUES -->
    <section class="charts-section">
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">R√©partition par Secteur</h3>
                </div>
                <div class="chart-body">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Sources de Financement</h3>
                </div>
                <div class="chart-body">
                    <canvas id="financingChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Statuts des Projets</h3>
                </div>
                <div class="chart-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">√âvolution Mensuelle</h3>
                </div>
                <div class="chart-body">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- TOP PROJETS -->
    <section class="projects-section">
        <div class="section-header">
            <h2 class="section-title">
                <i data-lucide="star"></i>
                Top Projets par Budget
            </h2>
        </div>

        <div class="table-container">
            <table class="projects-table">
                <thead>
                    <tr>
                        <th>Projet</th>
                        <th>Secteur</th>
                        <th>Budget</th>
                        <th>Progression</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in topProjects %}
                    <tr>
                        <td>
                            <div class="project-name">
                                {{ project.name }}
                                <span class="project-code">{{ project.code }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="sector-badge">{{ project.sector }}</span>
                        </td>
                        <td class="budget-cell">
                            <span class="budget-amount">{{ (project.budgetTotal / 1000000)|number_format(1, '.', ' ') }} M</span>
                            <span class="budget-currency">FCFA</span>
                        </td>
                        <td class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ project.progress ?? 0 }}%; background: {% if project.progress >= 70 %}var(--success-500){% elseif project.progress >= 40 %}var(--gold-500){% else %}var(--red-500){% endif %};"></div>
                            </div>
                            <span class="progress-text">{{ project.progress ?? 0 }}% compl√©t√©</span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ project.status }}">
                                {{ project.status }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ path('app_top_management_project_detail', {id: project.id}) }}" class="action-btn">
                                <i data-lucide="eye"></i>
                                D√©tails
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- PROJETS CRITIQUES -->
    <section class="critical-section">
        <div class="section-header">
            <h2 class="section-title">
                <i data-lucide="alert-circle"></i>
                Projets Critiques
            </h2>
        </div>

        <div class="critical-grid">
            {% for project in criticalProjects|slice(0, 6) %}
            <div class="critical-card">
                <div class="critical-header">
                    <span class="risk-badge risk-high">Risque √âlev√©</span>
                </div>
                <h4 class="critical-title">{{ project.name }}</h4>
                <p class="critical-sector">{{ project.sector }}</p>
                <div class="critical-stats">
                    <div class="critical-stat">
                        <span class="stat-label">Progression</span>
                        <span class="stat-value">{{ project.progress ?? 0 }}%</span>
                    </div>
                    <div class="critical-stat">
                        <span class="stat-label">Budget</span>
                        <span class="stat-value">{{ (project.budgetTotal / 1000000)|number_format(0, '.', ' ') }}M</span>
                    </div>
                </div>
                <a href="{{ path('app_top_management_project_detail', {id: project.id}) }}" class="critical-link">
                    Voir les d√©tails <i data-lucide="arrow-right"></i>
                </a>
            </div>
            {% endfor %}
        </div>
    </section>

</main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        lucide.createIcons();

        // Counter animation
        document.querySelectorAll('.kpi-value[data-count]').forEach(element => {
            const target = parseFloat(element.getAttribute('data-count'));
            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = Math.round(target);
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 20);
        });

        // Charts
        const chartColors = {
            primary: '#004d99',
            gold: '#daa520',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            red: '#c41e3a',
        };

        // Secteur Chart
        new Chart(document.getElementById('sectorChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: [{% for sector, data in sectorStats %}'{{ sector }}',{% endfor %}],
                datasets: [{
                    data: [{% for sector, data in sectorStats %}{{ data.count }},{% endfor %}],
                    backgroundColor: Object.values(chartColors)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { family: "'DM Sans', sans-serif", size: 11 }, padding: 15 } }
                }
            }
        });

        // Financing Chart
        new Chart(document.getElementById('financingChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: [{% for source, data in financingSourceStats %}'{{ source }}',{% endfor %}],
                datasets: [{
                    data: [{% for source, data in financingSourceStats %}{{ data.count }},{% endfor %}],
                    backgroundColor: Object.values(chartColors)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { family: "'DM Sans', sans-serif", size: 11 }, padding: 15 } }
                }
            }
        });

        // Status Chart
        new Chart(document.getElementById('statusChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: [{% for status, count in statusStats %}'{{ status }}',{% endfor %}],
                datasets: [{
                    label: 'Projets',
                    data: [{% for status, count in statusStats %}{{ count }},{% endfor %}],
                    backgroundColor: chartColors.primary
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // Evolution Chart
        new Chart(document.getElementById('evolutionChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [{% for month, data in monthlyEvolution %}'{{ month }}',{% endfor %}],
                datasets: [{
                    label: 'Projets',
                    data: [{% for month, data in monthlyEvolution %}{{ data.projects }},{% endfor %}],
                    borderColor: chartColors.primary,
                    backgroundColor: 'rgba(0, 77, 153, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    </script>
{% endblock %}
