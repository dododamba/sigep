{% extends 'base.html.twig' %}

{% block title %}{{ project.name }} - SIGEP Tchad{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/project-show.css') }}">
{% endblock %}

{% block body %}
<div class="content-area">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-left">
            <a href="{{ path('app_projects') }}" class="back-link">
                <i data-lucide="arrow-left"></i>
                Retour aux projets
            </a>
        </div>
        <div class="page-header-actions">
            <a href="{{ path('app_projects_edit', {id: project.id}) }}" class="btn btn-primary">
                <i data-lucide="edit-3"></i>
                Modifier
            </a>
            <button type="button" class="btn btn-danger-outline" onclick="openDeleteModal()">
                <i data-lucide="trash-2"></i>
                Supprimer
            </button>
        </div>
    </div>

    <!-- Project Hero Card -->
    <div class="project-hero">
        <div class="project-hero-header">
            <div class="project-icon-large {{ project.sector }}">
                <i data-lucide="{{ project.sectorIcon }}"></i>
            </div>
            <div class="project-hero-info">
                <div class="project-badges">
                    <span class="sector-badge {{ project.sector }}">{{ project.sectorLabel }}</span>
                    <span class="status-badge {{ project.status }}">{{ project.statusLabel }}</span>
                    <span class="priority-badge {{ project.priorite }}">{{ project.prioriteLabel }}</span>
                </div>
                <h1>{{ project.name }}</h1>
                <div class="project-meta">
                    <span class="project-code">
                        <i data-lucide="hash"></i>
                        {{ project.code }}
                    </span>
                    {% if project.localisation %}
                    <span class="project-location">
                        <i data-lucide="map-pin"></i>
                        {{ project.localisation }}
                    </span>
                    {% endif %}
                    {% if project.maitreOuvrage %}
                    <span class="project-owner">
                        <i data-lucide="building"></i>
                        {{ project.maitreOuvrage }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="project-progress-section">
            <div class="progress-header">
                <span class="progress-label">Progression globale</span>
                <span class="progress-value {% if project.progress >= 80 %}green{% elseif project.progress >= 50 %}blue{% elseif project.progress >= 25 %}gold{% else %}red{% endif %}">{{ project.progress }}%</span>
            </div>
            <div class="progress-bar-large">
                <div class="progress-fill-large {% if project.progress >= 80 %}green{% elseif project.progress >= 50 %}blue{% elseif project.progress >= 25 %}gold{% else %}red{% endif %}" 
                     style="width: {{ project.progress }}%"></div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i data-lucide="wallet"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ project.budgetTotal|number_format(2, ',', ' ') }}</span>
                <span class="stat-label">Budget total (Mds FCFA)</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i data-lucide="banknote"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ project.montantDecaisse|number_format(2, ',', ' ') }}</span>
                <span class="stat-label">Montant décaissé (Mds FCFA)</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon gold">
                <i data-lucide="percent"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ project.tauxDecaissement }}%</span>
                <span class="stat-label">Taux de décaissement</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <i data-lucide="users"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ project.beneficiaires|default('N/A') }}</span>
                <span class="stat-label">Bénéficiaires</span>
            </div>
        </div>
    </div>

    <!-- Details Grid -->
    <div class="details-grid">
        <!-- Description -->
        {% if project.description %}
        <div class="detail-card full-width">
            <div class="detail-card-header">
                <i data-lucide="file-text"></i>
                <h3>Description</h3>
            </div>
            <div class="detail-card-body">
                <p>{{ project.description|nl2br }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Dates -->
        <div class="detail-card">
            <div class="detail-card-header">
                <i data-lucide="calendar"></i>
                <h3>Planning</h3>
            </div>
            <div class="detail-card-body">
                <div class="detail-row">
                    <span class="detail-label">Date de début</span>
                    <span class="detail-value">{{ project.dateDebut ? project.dateDebut|date('d/m/Y') : 'Non définie' }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date de fin prévue</span>
                    <span class="detail-value">{{ project.dateFin ? project.dateFin|date('d/m/Y') : 'Non définie' }}</span>
                </div>
                {% if project.dateDebut and project.dateFin %}
                <div class="detail-row">
                    <span class="detail-label">Durée</span>
                    <span class="detail-value">
                        {% set diff = project.dateFin.diff(project.dateDebut) %}
                        {{ diff.y > 0 ? diff.y ~ ' an(s) ' : '' }}{{ diff.m > 0 ? diff.m ~ ' mois' : '' }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Financement -->
        <div class="detail-card">
            <div class="detail-card-header">
                <i data-lucide="coins"></i>
                <h3>Financement</h3>
            </div>
            <div class="detail-card-body">
                <div class="detail-row">
                    <span class="detail-label">Source</span>
                    <span class="detail-value">{{ project.sourceFinancement|default('Non spécifiée') }}</span>
                </div>
                {% if project.financementNational %}
                <div class="detail-row">
                    <span class="detail-label">National</span>
                    <span class="detail-value">{{ project.financementNational|number_format(2, ',', ' ') }} Mds FCFA</span>
                </div>
                {% endif %}
                {% if project.financementPartenaires %}
                <div class="detail-row">
                    <span class="detail-label">Partenaires</span>
                    <span class="detail-value">{{ project.financementPartenaires|number_format(2, ',', ' ') }} Mds FCFA</span>
                </div>
                {% endif %}
                {% if project.financementAutre %}
                <div class="detail-row">
                    <span class="detail-label">Autres</span>
                    <span class="detail-value">{{ project.financementAutre|number_format(2, ',', ' ') }} Mds FCFA</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Responsables -->
        <div class="detail-card">
            <div class="detail-card-header">
                <i data-lucide="users"></i>
                <h3>Responsables</h3>
            </div>
            <div class="detail-card-body">
                <div class="detail-row">
                    <span class="detail-label">Maître d'ouvrage</span>
                    <span class="detail-value">{{ project.maitreOuvrage|default('Non défini') }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Chef de projet</span>
                    <span class="detail-value">{{ project.chefProjet|default('Non défini') }}</span>
                </div>
                {% if project.institution %}
                <div class="detail-row">
                    <span class="detail-label">Institution</span>
                    <span class="detail-value">{{ project.institution.name }}</span>
                </div>
                {% endif %}
                {% if project.partnerPrincipal %}
                <div class="detail-row">
                    <span class="detail-label">Partenaire principal</span>
                    <span class="detail-value">{{ project.partnerPrincipal.name }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informations système -->
        <div class="detail-card">
            <div class="detail-card-header">
                <i data-lucide="info"></i>
                <h3>Informations système</h3>
            </div>
            <div class="detail-card-body">
                <div class="detail-row">
                    <span class="detail-label">ID</span>
                    <span class="detail-value">#{{ project.id }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Slug</span>
                    <span class="detail-value code">{{ project.slug }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Créé le</span>
                    <span class="detail-value">{{ project.createdAt ? project.createdAt|date('d/m/Y à H:i') : 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Dernière modification</span>
                    <span class="detail-value">{{ project.updatedAt ? project.updatedAt|date('d/m/Y à H:i') : 'Jamais' }}</span>
                </div>
            </div>
        </div>

        <!-- Notes -->
        {% if project.notes %}
        <div class="detail-card full-width">
            <div class="detail-card-header">
                <i data-lucide="sticky-note"></i>
                <h3>Notes</h3>
            </div>
            <div class="detail-card-body">
                <p>{{ project.notes|nl2br }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        <a href="{{ path('app_projects') }}" class="btn btn-outline">
            <i data-lucide="arrow-left"></i>
            Retour à la liste
        </a>
        <div class="action-bar-right">
            <form action="{{ path('app_projects_duplicate', {id: project.id}) }}" method="POST" style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('duplicate' ~ project.id) }}">
                <button type="submit" class="btn btn-secondary">
                    <i data-lucide="copy"></i>
                    Dupliquer
                </button>
            </form>
            <a href="{{ path('app_projects_edit', {id: project.id}) }}" class="btn btn-primary">
                <i data-lucide="edit-3"></i>
                Modifier
            </a>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-icon danger">
                <i data-lucide="alert-triangle"></i>
            </div>
            <h3>Confirmer la suppression</h3>
            <p>Êtes-vous sûr de vouloir supprimer le projet "{{ project.name }}" ?</p>
            <p class="warning-text">Cette action est irréversible.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
            <form action="{{ path('app_projects_delete', {id: project.id}) }}" method="POST" style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ project.id) }}">
                <button type="submit" class="btn btn-danger">
                    <i data-lucide="trash-2"></i>
                    Supprimer
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    lucide.createIcons();

    function openDeleteModal() {
        document.getElementById('deleteModal').classList.add('show');
        lucide.createIcons();
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('show');
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}
